{"name":"Mighty Summoner","type":"script","scope":"global","author":"npmYF618vZgxA5SD","img":"icons/magic/control/debuff-energy-hold-levitate-green.webp","command":"/**\n * https://www.dndbeyond.com/classes/druid#CircleoftheShepherd => Mighty Summoner\n * \n * icon suggestion: icons/magic/control/debuff-energy-hold-levitate-green.webp\n * \n * Create one valid target, hit with Macro, copy and paste (Tokens appear on cursor).\n * \n */\n\nconst icon = \"icons/magic/control/debuff-energy-hold-levitate-green.webp\";\nconst label = Tablerules.dictionary.class.druid.shepherd.features.mightySummoner.label;\nconst macroLabel = Tablerules.dictionary.class.druid.shepherd.features.mightySummoner.label;\n\nactor = canvas.tokens.hover?.actor;\n\nif (canvas.tokens.hover === null) {\n    ui.notifications.warn(`${macroLabel}, Actor hovered ${actor?.name} invalid target.`);\n    return;\n}\n\nif (canvas.tokens.hover.document.disposition !== 1) {// guess your own summons should always be friendly\n    ui.notifications.warn(`${macroLabel}, Actor hovered ${actor?.name} is not friendly: ${canvas.tokens.hover.document.disposition}.`);\n    return;\n}\n\nconst rollFormula = game.actors.find(a => a._id === canvas.tokens.hover.document.actorId).system.attributes.hp.formula;\nif (rollFormula === undefined) {\n    ui.notifications.warn(`${macroLabel}, Actor hovered ${actor?.name} invalid target.`);\n    return;\n}\n\nconst hitDice = new Roll(rollFormula).evaluate({ async: false }).dice.map(d => d.number).reduce((previousValue, currentValue) => previousValue + currentValue);\n\nconst effectData = { icon, label };\nconst effect = actor.effects.find(e => e.getFlag(\"world\", Tablerules.dictionary.class.druid.shepherd.features.mightySummoner.key));\nfoundry.utils.setProperty(effectData, `flags.world.${Tablerules.dictionary.class.druid.shepherd.features.mightySummoner.key}`, true);\nfoundry.utils.setProperty(effectData, \"flags.core.statusId\", Tablerules.dictionary.class.druid.shepherd.features.mightySummoner.label);\nif (effect) {\n    ui.notifications.warn(`${macroLabel}, Actor hovered ${actor?.name} already mightily empowered.`);\n    return;\n}\nelse {\n    await actor.createEmbeddedDocuments(\"ActiveEffect\", [effectData]);\n}\n\nawait actor.update({ \"system.attributes.hp.value\": actor.system.attributes.hp.value + 2 * hitDice, \"system.attributes.hp.max\": actor.system.attributes.hp.max + 2 * hitDice });\n\nconst items = actor.items.filter(i => i.type === \"weapon\");\n\nfor (i = 0; i < items.length; i++) {\n    const changes = items[i].system.properties;\n    changes.mgc = true;\n    await items[i].update({ \"system.properties\": changes });\n}\n\n\n// ChatMessage","ownership":{"default":0,"npmYF618vZgxA5SD":3},"flags":{"core":{"sourceId":"Macro.izzX4exXuihfzdX3"}},"_stats":{"systemId":"dnd5e","systemVersion":"2.0.3","coreVersion":"10.290","createdTime":1668211949236,"modifiedTime":1668348736279,"lastModifiedBy":"npmYF618vZgxA5SD"},"folder":null,"sort":0,"_id":"oZVxL5GMgubSCJLk"}
